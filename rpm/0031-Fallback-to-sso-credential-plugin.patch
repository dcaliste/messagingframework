From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Damien Caliste <dcaliste@free.fr>
Date: Tue, 8 Oct 2024 16:59:57 +0200
Subject: [PATCH] Fallback to sso credential plugin.

Change-Id: Ie4237908bdc69cb681f6cee830876a4d60dd1641
---
 .../qmfmessageserver/qmailcredentials.cpp      | 18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

diff --git a/src/libraries/qmfmessageserver/qmailcredentials.cpp b/src/libraries/qmfmessageserver/qmailcredentials.cpp
index 299ae9db..c5ca1e36 100644
--- a/src/libraries/qmfmessageserver/qmailcredentials.cpp
+++ b/src/libraries/qmfmessageserver/qmailcredentials.cpp
@@ -192,14 +192,13 @@ QMailCredentialsInterface *QMailCredentialsFactory::getServiceForAccount(const Q
     const QMailAccountConfiguration::ServiceConfiguration &auth = config.serviceConfiguration(QLatin1String("auth"));
     if (auth.id().isValid()) {
         const QString plugin = auth.value(QLatin1String("plugin"));
-        if (!plugin.isEmpty()) {
-            credentials = QMailCredentialsFactory::createService(plugin, parent);
-            if (!credentials) {
-                qMailLog(Messaging) << "Credential plugin" << plugin
-                                    << "is not available for account id: "
-                                    << config.id()
-                                    << ", account configuration will be used";
-            }
+        credentials = QMailCredentialsFactory::createService
+            (plugin.isEmpty() ? QLatin1String("sso") : plugin, parent);
+        if (!credentials) {
+            qMailLog(Messaging) << "Credential plugin" << plugin
+                                << "is not available for account id: "
+                                << config.id()
+                                << ", account configuration will be used";
         }
     }
     if (!credentials) {
@@ -255,6 +254,9 @@ void QMailCredentialsInterface::invalidate(const QString &source)
                      QLatin1String("true"));
         if (!source.isEmpty()) {
             srv.setValue(QLatin1String("CredentialsNeedUpdateFrom"), source);
+        } else {
+            srv.setValue(QLatin1String("CredentialsNeedUpdateFrom"),
+                         QLatin1String("messageserver5"));
         }
         QMailStore::instance()->updateAccountConfiguration(&config);
     }
